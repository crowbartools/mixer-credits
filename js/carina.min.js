var carina=function(t){"use strict";var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};function n(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t};function o(){}function i(){i.init.call(this)}function s(t){return void 0===t._maxListeners?i.defaultMaxListeners:t._maxListeners}function c(t,e,n,r){var i,c,a,u;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((c=t._events)?(c.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),c=t._events),a=c[e]):(c=t._events=new o,t._eventsCount=0),a){if("function"==typeof a?a=c[e]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),!a.warned&&(i=s(t))&&i>0&&a.length>i){a.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+e+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=t,h.type=e,h.count=a.length,u=h,"function"==typeof console.warn?console.warn(u):console.log(u)}}else a=c[e]=n,++t._eventsCount;return t}function a(t,e,n){var r=!1;function o(){t.removeListener(e,o),r||(r=!0,n.apply(t,arguments))}return o.listener=n,o}function u(t){var e=this._events;if(e){var n=e[t];if("function"==typeof n)return 1;if(n)return n.length}return 0}function h(t,e){for(var n=new Array(e);e--;)n[e]=t[e];return n}o.prototype=Object.create(null),i.EventEmitter=i,i.usingDomains=!1,i.prototype.domain=void 0,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.init=function(){this.domain=null,i.usingDomains&&(!(void 0).active||this instanceof(void 0).Domain||(this.domain=(void 0).active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new o,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},i.prototype.getMaxListeners=function(){return s(this)},i.prototype.emit=function(t){var e,n,r,o,i,s,c,a="error"===t;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(c=this.domain,a){if(e=arguments[1],!c){if(e instanceof Error)throw e;var u=new Error('Uncaught, unspecified "error" event. ('+e+")");throw u.context=e,u}return e||(e=new Error('Uncaught, unspecified "error" event')),e.domainEmitter=this,e.domain=c,e.domainThrown=!1,c.emit("error",e),!1}if(!(n=s[t]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:!function(t,e,n){if(e)t.call(n);else for(var r=t.length,o=h(t,r),i=0;i<r;++i)o[i].call(n)}(n,l,this);break;case 2:!function(t,e,n,r){if(e)t.call(n,r);else for(var o=t.length,i=h(t,o),s=0;s<o;++s)i[s].call(n,r)}(n,l,this,arguments[1]);break;case 3:!function(t,e,n,r,o){if(e)t.call(n,r,o);else for(var i=t.length,s=h(t,i),c=0;c<i;++c)s[c].call(n,r,o)}(n,l,this,arguments[1],arguments[2]);break;case 4:!function(t,e,n,r,o,i){if(e)t.call(n,r,o,i);else for(var s=t.length,c=h(t,s),a=0;a<s;++a)c[a].call(n,r,o,i)}(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(r-1),i=1;i<r;i++)o[i-1]=arguments[i];!function(t,e,n,r){if(e)t.apply(n,r);else for(var o=t.length,i=h(t,o),s=0;s<o;++s)i[s].apply(n,r)}(n,l,this,o)}return!0},i.prototype.addListener=function(t,e){return c(this,t,e,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(t,e){return c(this,t,e,!0)},i.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,a(this,t,e)),this},i.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,a(this,t,e)),this},i.prototype.removeListener=function(t,e){var n,r,i,s,c;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[t]))return this;if(n===e||n.listener&&n.listener===e)0==--this._eventsCount?this._events=new o:(delete r[t],r.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(i=-1,s=n.length;s-- >0;)if(n[s]===e||n[s].listener&&n[s].listener===e){c=n[s].listener,i=s;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new o,this;delete r[t]}else!function(t,e){for(var n=e,r=n+1,o=t.length;r<o;n+=1,r+=1)t[n]=t[r];t.pop()}(n,i);r.removeListener&&this.emit("removeListener",t,c||e)}return this},i.prototype.removeAllListeners=function(t){var e,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new o,this._eventsCount=0):n[t]&&(0==--this._eventsCount?this._events=new o:delete n[t]),this;if(0===arguments.length){for(var r,i=Object.keys(n),s=0;s<i.length;++s)"removeListener"!==(r=i[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new o,this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(e)do{this.removeListener(t,e[e.length-1])}while(e[0]);return this},i.prototype.listeners=function(t){var e,n=this._events;return n&&(e=n[t])?"function"==typeof e?[e.listener||e]:function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(e):[]},i.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):u.call(t,e)},i.prototype.listenerCount=u,i.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var l=function(t){function e(e){var n=t.call(this)||this;return n.message=e,Error.captureStackTrace?(Error.captureStackTrace(n,n.constructor),n):(n.stack=(new Error).stack,n)}return n(e,t),e.setProto=function(t){Object.setPrototypeOf?Object.setPrototypeOf(t,this.prototype):t.__proto__=this.prototype},e}(Error),f=function(t){function e(){var n=t.call(this,"Packet was cancelled or Carina was closed before a reply was received.")||this;return e.setProto(n),n}return n(e,t),e}(l),p=function(t){function e(n){var r=t.call(this,"Timeout out waiting for event "+n)||this;return r.eventName=n,e.setProto(r),r}return n(e,t),e}(l),v=function(t){function e(n){var r=t.call(this,n)||this;return e.setProto(r),r}return n(e,t),e}(l);!function(t){var e=function(t){function e(n,r){var o=t.call(this,r)||this;return o.code=n,e.setProto(o),o}return n(e,t),e.prototype.shouldReconnect=function(){return!0},e}(l);t.ConstellationError=e;var r={};t.from=function(t){var n=t.code,o=t.message;return r[n]?new r[n](o):new e(n,o)};var o=function(t){function e(n){var r=t.call(this,4e3,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.InvalidPayload=o,r[4e3]=o;var i=function(t){function e(n){var r=t.call(this,4001,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.PayloadDecompression=i,r[4001]=i;var s=function(t){function e(n){var r=t.call(this,4002,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.UnknownPacketType=s,r[4002]=s;var c=function(t){function e(n){var r=t.call(this,4003,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.UnknownMethodName=c,r[4003]=c;var a=function(t){function e(n){var r=t.call(this,4004,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.InvalidMethodArguments=a,r[4004]=a;var u=function(t){function e(n){var r=t.call(this,4005,n)||this;return e.setProto(r),r}return n(e,t),e.prototype.shouldReconnect=function(){return!1},e}(e);t.SessionExpired=u,r[4005]=u;var h=function(t){function r(n){var r=t.call(this,4106,n)||this;return e.setProto(r),r}return n(r,t),r}(e);t.LiveUnknownEvent=h,r[4106]=h;var f=function(t){function e(n){var r=t.call(this,4107,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.LiveAccessDenied=f,r[4107]=f;var p=function(t){function e(n){var r=t.call(this,4108,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.LiveAlreadySubscribed=p,r[4108]=p;var v=function(t){function e(n){var r=t.call(this,4109,n)||this;return e.setProto(r),r}return n(e,t),e}(e);t.LiveNotSubscribed=v,r[4109]=v}(t.ConstellationError||(t.ConstellationError={}));var d,m=function(){function t(t,e){void 0===t&&(t=2e4),void 0===e&&(e=500),this.maxDelay=t,this.baseDelay=e,this.retries=0}return t.prototype.next=function(){return Math.min(this.maxDelay,(1<<this.retries++)*this.baseDelay)},t.prototype.reset=function(){this.retries=0},t}();!function(t){t[t.Pending=1]="Pending",t[t.Sending=2]="Sending",t[t.Replied=3]="Replied"}(d||(d={}));var y=function(t){function e(n,r){var o=t.call(this)||this;return o.state=d.Pending,o.data={id:e.packetIncr++,type:"method",method:n,params:r},o}return n(e,t),e.prototype.id=function(){return this.data.id},e.prototype.toJSON=function(){return this.data},e.prototype.setTimeout=function(t){this.timeout=t},e.prototype.getTimeout=function(t){return this.timeout||t},e.prototype.getState=function(){return this.state},e.prototype.setState=function(t){t!==this.state&&(this.state=t)},e.packetIncr=0,e}(i),g=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}n(e,t)}(y),Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)});function w(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}}function k(t,e){if(t.map)return t.map(e);for(var n=[],r=0;r<t.length;r++)n.push(e(t[r],r));return n}var S=Object.keys||function(t){var e=[];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.push(n);return e};function b(t,e,n){return void 0===n&&(n=12e4),new Promise(function(r,o){var i,s=function(t){clearTimeout(i),r(t)};t.once(e,s),i=setTimeout(function(){t.removeListener(e,s),o(new p(e))},n)})}var L,C="0.11.0",_=function(){function t(t){this.threshold=t}return t.prototype.shouldZip=function(t){return t.length>this.threshold},t}(),P=function(){function t(t){this.detector=t}return t.prototype.outgoing=function(t,e){return this.detector.shouldZip(t,e)?(void 0)(t):t},t.prototype.incoming=function(t){return"string"!=typeof t?(void 0)(t,{to:"string"}):t},t}();(L=t.State||(t.State={}))[L.Idle=1]="Idle",L[L.Connecting=2]="Connecting",L[L.Connected=3]="Connected",L[L.Closing=4]="Closing",L[L.Reconnecting=5]="Reconnecting",L[L.Refreshing=6]="Refreshing";var E=/^[\w_-]+?\.[\w_-]+?\.([\w_-]+)?$/i,T=function(e){function o(n){void 0===n&&(n={});var r=e.call(this)||this;if(r.state=t.State.Idle,r.setOptions(n),void 0===o.WebSocket)throw new Error("Cannot find a websocket implementation; please provide one by running ConstellationSocket.WebSocket = myWebSocketModule;");return r.on("message",function(t){return r.extractMessage(t.data)}),r.on("open",function(){return r.schedulePing()}),r.on("event:hello",function(){r.options.reconnectionPolicy.reset(),r.setState(t.State.Connected)}),r.on("close",function(t){return r.handleSocketClose(t)}),r}return n(o,e),o.prototype.setOptions=function(t){if(this.options=r({},{url:"wss://constellation.mixer.com",userAgent:"Carina "+C,replyTimeout:1e4,isBot:!1,autoReconnect:!0,reconnectionPolicy:new m,pingInterval:1e4},{transform:new P(t.gzip||new _(1024))},this.options,t),this.options.jwt&&!E.test(this.options.jwt))throw new Error("Invalid jwt");if(this.options.jwt&&this.options.authToken)throw new Error("Cannot connect to Constellation with both JWT and OAuth token.")},o.prototype.connect=function(){var e=this,n=this.options;if(this.state===t.State.Closing)return this.setState(t.State.Refreshing),this;var i,s,c,a,u=n.gzip?"cnstl-gzip":"cnstl",h={headers:{"User-Agent":n.userAgent,"X-Is-Bot":n.isBot}},l=n.url,f=n.queryString;n.authToken?h.headers.Authorization="Bearer "+n.authToken:n.jwt&&(f=r({},f,{jwt:n.jwt})),l+="?"+(i=f,s=s||"&",c=c||"=",null===i&&(i=void 0),"object"==typeof i?k(S(i),function(t){var e=encodeURIComponent(w(t))+c;return g(i[t])?k(i[t],function(t){return e+encodeURIComponent(w(t))}).join(s):e+encodeURIComponent(w(i[t]))}).join(s):a?encodeURIComponent(w(a))+c+encodeURIComponent(w(i)):"");var p=new o.WebSocket(l,u,h);return this.socket=p,this.socket.binaryType="arraybuffer",this.setState(t.State.Connecting),this.rebroadcastEvent("open"),this.rebroadcastEvent("close"),this.rebroadcastEvent("message"),this.socket.addEventListener("error",function(n){e.state!==t.State.Closing&&e.emit("error",n)}),this},o.prototype.getState=function(){return this.state},o.prototype.close=function(){if(this.state===t.State.Reconnecting)return clearTimeout(this.reconnectTimeout),void this.setState(t.State.Idle);this.state!==t.State.Idle&&(this.setState(t.State.Closing),this.socket.close(),clearTimeout(this.pingTimeout))},o.prototype.execute=function(t,e){return void 0===e&&(e={}),this.send(new y(t,e))},o.prototype.send=function(t){var e=t.getTimeout(this.options.replyTimeout),n=Promise.race([b(this,"reply:"+t.id(),e).then(function(t){if(t.err)throw t.err;return t.result}),b(this,"close",e+1).then(function(){throw new f})]);return t.emit("send",n),t.setState(d.Sending),this.sendPacketInner(t),n},o.prototype.setState=function(t){this.state!==t&&(this.state=t,this.emit("state",t))},o.prototype.sendPacketInner=function(t){var e=JSON.stringify(t),n=this.options.transform.outgoing(e,t.toJSON());this.emit("send",n),this.socket.send(n)},o.prototype.extractMessage=function(e){var n;try{n=JSON.parse(this.options.transform.incoming(e))}catch(r){throw new v("Message returned was not valid JSON: "+r.stack)}switch(this.schedulePing(),n.type){case"event":this.emit("event:"+n.event,n.data);break;case"reply":var r=n.error?t.ConstellationError.from(n.error):null;this.emit("reply:"+n.id,{err:r,result:n.result});break;default:throw new v('Unknown message type "'+n.type+'"')}},o.prototype.rebroadcastEvent=function(t){var e=this;this.socket.addEventListener(t,function(n){return e.emit(t,n)})},o.prototype.schedulePing=function(){var e=this;clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(function(){if(e.state===t.State.Connected){var n=new y("ping",null),r=e.options.replyTimeout;setTimeout(function(){e.sendPacketInner(n),e.emit("ping")}),Promise.race([b(e,"reply:"+n.id(),r),b(e,"close",r+1)]).then(function(){return e.emit("pong")}).catch(function(t){e.socket.close(),e.emit("warning",t)})}},this.options.pingInterval)},o.prototype.handleSocketClose=function(e){var n=this,r=this.options,o=r.autoReconnect,i=r.reconnectionPolicy;if(this.state===t.State.Refreshing)return this.setState(t.State.Idle),void this.connect();if(this.state!==t.State.Closing&&o){var s=t.ConstellationError.from({code:e.code,message:e.reason});if(!s.shouldReconnect())return this.setState(t.State.Idle),void this.emit("error",s);this.setState(t.State.Reconnecting),this.reconnectTimeout=setTimeout(function(){return n.connect()},i.next())}else this.setState(t.State.Idle)},o.WebSocket="undefined"==typeof WebSocket?null:WebSocket,o}(i),O=function(){function e(t,e,n){this.socket=t,this.slug=e,this.onError=n,this.listeners=[]}return e.prototype.add=function(t){0===this.listeners.length&&this.addSocketListener(),this.listeners.push(t)},e.prototype.remove=function(t){this.listeners=this.listeners.filter(function(e){return e!==t}),0===this.listeners.length&&this.removeSocketListener()},e.prototype.removeAll=function(){this.listeners=[],this.removeSocketListener()},e.prototype.listenerCount=function(){return this.listeners.length},e.prototype.addSocketListener=function(){var e=this;this.socketStateListener=function(n){n===t.State.Connected&&e.socket.execute("livesubscribe",{events:[e.slug]}).catch(function(t){t instanceof f||e.onError(t)})},this.socketDataListener=function(t){t.channel===e.slug&&e.listeners.forEach(function(e){return e(t.payload)})},this.socket.on("state",this.socketStateListener),this.socket.on("event:live",this.socketDataListener),this.socketStateListener(this.socket.getState())},e.prototype.removeSocketListener=function(){this.socketStateListener&&(this.socket.getState()===t.State.Connected&&this.socket.execute("liveunsubscribe",{events:[this.slug]}).catch(function(){}),this.socket.removeListener("state",this.socketStateListener),this.socket.removeListener("event:live",this.socketDataListener),this.socketStateListener=void 0,this.socketDataListener=void 0)},e}(),j=function(t){function e(e){void 0===e&&(e={});var n=t.call(this)||this;return n.subscriptions=Object.create(null),n.socket=new T(e),n.socket.on("error",function(t){return n.emit("error",t)}),n}return n(e,t),Object.defineProperty(e,"WebSocket",{get:function(){return T.WebSocket},set:function(t){T.WebSocket=t},enumerable:!0,configurable:!0}),e.prototype.setOptions=function(t){this.socket.setOptions(t)},e.prototype.open=function(){return this.socket.connect(),this},e.prototype.close=function(){this.socket.close()},e.prototype.subscribe=function(t,e){var n=this,r=this.subscriptions[t];return r||(r=this.subscriptions[t]=new O(this.socket,t,function(t){return n.emit("error",t)})),r.add(e),Promise.resolve()},e.prototype.unsubscribe=function(t,e){var n=this.subscriptions[t];return n?(e?n.remove(e):n.removeAll(),0===n.listenerCount()&&delete this.subscriptions[t],Promise.resolve()):Promise.resolve()},e}(i);return t.Carina=j,t.Subscription=O,t.SocketState=t.State,t.CarinaError=l,t.CancelledError=f,t.EventTimeoutError=p,t.MessageParseError=v,t.SizeThresholdGzipDetector=_,t.GzipTransform=P,t.ConstellationSocket=T,t}({});
